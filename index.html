<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watchlist Dashboard V8</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation/dist/chartjs-plugin-annotation.min.js"></script>
    
    <!-- SheetJS for .xlsx export -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Icons" />

    <style>
        :root {
            --bg-color: #ffffff;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --text-primary: #2c3e50;
            --text-secondary: #555;
            --border-color: #e0e0e0;
            --header-bg: #f8f9fa;
            --hover-bg: #f5f5f5;
            --modal-bg: #fefefe;
            --modal-overlay-bg: rgba(0,0,0,0.6);
            --button-bg: #f0f0f0;
            --button-active-bg: #d1e3f8;
            --shadow-light: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-strong: 0 5px 20px rgba(0,0,0,0.3);
            --primary-color: #4a90e2;
            --positive-color: #28a745;
            --negative-color: #dc3545;
        }

        body.dark-mode {
            --bg-color: #1a1a1a;
            --bg-gradient: linear-gradient(135deg, #2c3e50 0%, #1a1a1a 100%);
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --border-color: #444;
            --header-bg: #2c3e50;
            --hover-bg: #3a4a5a;
            --modal-bg: #282828;
            --modal-overlay-bg: rgba(0,0,0,0.8);
            --button-bg: #333;
            --button-active-bg: #4a90e2;
            --shadow-light: 0 4px 20px rgba(0, 0, 0, 0.3);
            --shadow-strong: 0 5px 20px rgba(0,0,0,0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 1800px; margin: 0 auto; padding: 15px; }

        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); display: flex;
            justify-content: center; align-items: center; flex-direction: column;
            z-index: 9999; transition: opacity 0.3s ease; color: white;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2); width: 48px; height: 48px;
            border-radius: 50%; border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-text { margin-top: 20px; font-size: 1.2rem; font-weight: 500; }

        .main-content {
            background: var(--bg-color); border-radius: 12px;
            padding: 25px; box-shadow: var(--shadow-light);
            transition: background-color 0.3s;
        }

        .header-controls {
            display: flex; justify-content: flex-end; align-items: center;
            margin-bottom: 10px; gap: 10px;
        }
        #theme-toggle {
            cursor: pointer; background: none; border: none; padding: 5px;
            display: flex; align-items: center; justify-content: center;
        }
        #theme-toggle svg { width: 24px; height: 24px; fill: var(--text-primary); }

        .header-bar {
            display: flex; justify-content: space-between; align-items: flex-end;
            border-bottom: 1px solid var(--border-color); margin-bottom: 20px;
            position: sticky; top: 0; background: var(--bg-color); z-index: 100; padding-top: 10px;
        }
        
        .tabs, .chart-sub-tabs { display: flex; margin-bottom: -1px; padding-left: 10px; border-bottom: 1px solid var(--border-color); }
        .tab-link, .chart-sub-tab-link {
            padding: 10px 20px; cursor: pointer; font-size: 1.05rem; font-weight: 500; 
            transition: all 0.2s ease; color: var(--text-secondary); background-color: var(--button-bg);
            border: 1px solid var(--border-color); border-bottom: none; border-radius: 8px 8px 0 0;
            margin-right: 4px; position: relative; top: 0; display: flex; align-items: center; gap: 6px;
        }
        .tab-link:hover, .chart-sub-tab-link:hover { background-color: var(--hover-bg); color: var(--primary-color); }
        .tab-link.active, .chart-sub-tab-link.active {
            color: var(--primary-color); background-color: var(--bg-color); font-weight: 600;
            border-bottom: 1px solid var(--bg-color); z-index: 2; box-shadow: 0 -3px 6px rgba(0,0,0,0.05);
            top: 1px; padding-top: 12px; margin-top: -2px;
        }
        .chart-sub-tab-link { font-size: 0.95rem; padding: 8px 20px; }
        
        .tab-content { display: none; animation: fadeIn 0.5s; padding-top: 15px;}
        .tab-content.active { display: block; }
        .view-content { display: none; }
        .view-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Summary Tables */
        .summary-card table { width: 100%; border-collapse: collapse; text-align: right; }
        .summary-card th, .summary-card td { padding: 8px 12px; border-bottom: 1px solid var(--border-color); white-space: nowrap; font-size: 0.95rem; border-right: none; }
        .summary-card td:first-child, .summary-card th:first-child { text-align: left; }
        .summary-card th { cursor: pointer; }
        .summary-card th:hover { background-color: var(--button-active-bg); }
        tr:hover { background-color: var(--hover-bg); }
        .clickable-row { cursor: pointer; }
        .text-positive { color: var(--positive-color) !important; font-weight: 500; }
        .text-negative { color: var(--negative-color) !important; font-weight: 500; }
        
        /* Chart 2x2 Grid */
        .chart-grid-2x2 {
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 450px 450px; gap: 20px; margin-bottom: 20px;
        }
        .chart-grid-item {
            position: relative; background: var(--bg-color); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 10px; box-shadow: var(--shadow-light);
        }

        /* Stats Table */
        .stats-table-container { margin-top: 20px; overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; }
        .stats-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .stats-table th, .stats-table td { padding: 8px 12px; border: 1px solid var(--border-color); text-align: right; white-space: nowrap; }
        .stats-table th { background-color: var(--header-bg); font-weight: 600; text-align: center; }
        .stats-table td:first-child { text-align: left; font-weight: 600; min-width: 120px; }

        .controls-input, .controls-select {
            border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; font-size: 0.95rem;
            background-color: var(--bg-color); color: var(--text-primary);
            display: inline-flex; align-items: center; gap: 5px; cursor: pointer;
        }

        .modal {
            position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
            background-color: var(--modal-overlay-bg); opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal.show { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: var(--modal-bg); margin: 5% auto; padding: 25px;
            border-radius: 12px; width: 90%; max-width: 1000px; box-shadow: var(--shadow-strong);
            position: relative; transform: translateY(-50px); transition: transform 0.3s ease-out;
        }
        .close { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        #summary { padding: 10px 0; }
        .summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .summary-header-left { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        #summary-content-container { display: flex; flex-direction: column; gap: 20px; }
        .summary-card {
            border: 1px solid var(--border-color); border-radius: 8px; padding: 15px;
            background: var(--bg-color); display: flex; flex-direction: column;
            box-shadow: var(--shadow-light); overflow: auto; position: relative; padding-top: 35px; 
        }
        .summary-card-label { position: absolute; top: 10px; left: 15px; font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .summary-card th.hidden-col, .summary-card td.hidden-col { display: none; }

        /* News with Resizable Pane */
        #news-container { display: flex; height: 75vh; width: 100%; overflow: hidden; border: 1px solid var(--border-color); border-radius: 8px; }
        #news-left-pane { flex: 0 0 40%; min-width: 350px; display: flex; flex-direction: column; background: var(--bg-color); border-right: 1px solid var(--border-color); }
        #news-resizer { width: 5px; cursor: col-resize; background: #ddd; transition: background 0.2s; }
        #news-resizer:hover { background: var(--primary-color); }
        #news-right-pane { flex: 1; min-width: 300px; padding: 20px; background-color: var(--hover-bg); overflow-y: auto; }
        
        .news-item { padding: 12px 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s; }
        .news-item:hover { background-color: var(--hover-bg); }
        .news-item.active { background-color: var(--button-active-bg); border-left: 4px solid var(--primary-color); }
        .news-meta { display: flex; gap: 8px; font-size: 0.8rem; color: #666; margin-bottom: 4px; flex-wrap: wrap; align-items: center; }
        .news-tag { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; }
        .news-title { font-weight: 600; font-size: 0.95rem; line-height: 1.4; }
        
        #news-filters {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background-color: var(--header-bg);
            align-items: center;
        }
        
        .date-range-dropdown {
            position: relative;
            display: inline-block;
        }
        .date-range-content {
            display: none;
            position: absolute;
            background-color: var(--modal-bg);
            min-width: 200px;
            box-shadow: var(--shadow-strong);
            padding: 5px;
            z-index: 1000;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }
        .date-range-content.show { display: block; }
        .date-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.95rem;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }
        .date-option:last-child { border-bottom: none; }
        .date-option:hover { background-color: var(--hover-bg); color: var(--primary-color); }
        
        .custom-date-row {
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 5px;
            background: var(--bg-color);
        }
        .custom-date-row.active { display: flex; }

        /* MCI Manual Grid */
        .mci-grid-wrapper { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; max-height: 60vh; }
        .mci-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .mci-table th, .mci-table td { padding: 5px; border: 1px solid var(--border-color); text-align: center; vertical-align: middle; }
        
        .mci-table th { background-color: var(--header-bg); position: sticky; top: 0; z-index: 10; font-weight: 600; font-size: 0.95rem; }
        .mci-table td:first-child { background-color: var(--header-bg); position: sticky; left: 0; z-index: 5; font-weight: 600; text-align: left; padding-left: 10px; font-size: 0.9rem; }
        
        .mci-input { width: 70px; padding: 6px; border: 1px solid transparent; text-align: right; background: transparent; color: inherit; font-family: inherit; font-size: 0.95rem; }
        .mci-input:hover { border-color: #ccc; background: var(--bg-color); }
        .mci-input:focus { border-color: var(--primary-color); background: var(--bg-color); outline: none; border-radius: 4px; }
        .mci-input::-webkit-outer-spin-button, .mci-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .mci-input[type=number] { -moz-appearance: textfield; }

        .mci-header-input { width: 90px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; font-size: 0.95rem; }
        
        .column-list-container { max-height: 400px; overflow-y: auto; }

    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text">Loading latest data from GitHub...</p>
    </div>

    <div class="container">
        <div class="header-controls">
            <button id="theme-toggle" title="Toggle color mode">
                <span id="theme-icon-sun"><i class="material-icons">light_mode</i></span>
                <span id="theme-icon-moon" style="display: none;"><i class="material-icons">dark_mode</i></span>
            </button>
        </div>

        <div class="main-content">
            <div class="header-bar">
                <div class="tabs">
                    <div class="tab-link active" onclick="openTab(event, 'summary')"><i class="material-icons">dashboard</i> Summary</div>
                    <div class="tab-link" onclick="openTab(event, 'chart-main')"><i class="material-icons">show_chart</i> Chart</div>
                    <div class="tab-link" onclick="openTab(event, 'news')"><i class="material-icons">article</i> News</div>
                    <div class="tab-link" onclick="openTab(event, 'mci-settings')"><i class="material-icons">settings</i> MCI Settings</div>
                </div>
            </div>

            <div id="summary" class="tab-content active">
                <div class="summary-header">
                    <div class="summary-header-left">
                        <label for="summary-as-of-date">As of:</label>
                        <input type="date" id="summary-as-of-date" class="controls-input" onchange="updateSummaryReferenceDate(this.value)">
                        <button class="controls-input" onclick="openColumnModal()"><i class="material-icons">view_column</i> Columns</button>
                    </div>
                </div>
                <div id="summary-content-container">
                    <div id="summary-equity-index" class="summary-card">
                        <div class="summary-card-label">Benchmark</div>
                        <div class="table-content-wrapper"><table></table></div>
                    </div>
                    <div id="summary-tw-stocks" class="summary-card">
                        <div class="summary-card-label">Watchlist</div>
                        <div class="table-content-wrapper"><table></table></div>
                    </div>
                    <div id="summary-us-stocks" class="summary-card">
                         <div class="summary-card-label">Peers</div>
                        <div class="table-content-wrapper"><table></table></div>
                    </div>
                </div>
            </div>

            <div id="chart-main" class="tab-content">
                <div class="chart-sub-tabs">
                     <div class="chart-sub-tab-link active" onclick="openChartSubTab(event, 'chart-grid')">Performance Grid</div>
                     <div class="chart-sub-tab-link" onclick="openChartSubTab(event, 'chart-mci')">TSMC vs MCI</div>
                </div>

                <div id="chart-grid" class="view-content active" style="padding-top:20px;">
                    <div class="chart-grid-2x2">
                        <div class="chart-grid-item">
                            <canvas id="canvas-1y"></canvas>
                        </div>
                        <div class="chart-grid-item">
                            <canvas id="canvas-ytd"></canvas>
                        </div>
                        <div class="chart-grid-item">
                            <canvas id="canvas-1m"></canvas>
                        </div>
                        <div class="chart-grid-item">
                            <canvas id="canvas-1w"></canvas>
                        </div>
                    </div>
                    <div class="stats-table-container">
                         <table class="stats-table" id="stats-table-grid">
                             <!-- Populated by JS -->
                         </table>
                    </div>
                </div>

                <div id="chart-mci" class="view-content" style="padding-top:20px;">
                     <div style="height: 600px; width: 100%; border:1px solid var(--border-color); padding:10px; border-radius:8px;">
                        <canvas id="canvas-mci-comp"></canvas>
                     </div>
                     <p style="margin-top:10px; color: var(--text-secondary); font-size: 0.9rem;">
                        * Base = 100 on 2020-01-01. MCI is calculated daily using the weighted sum of member returns based on quarterly weights.
                     </p>
                </div>
            </div>

            <div id="news" class="tab-content">
                <div id="news-container">
                    <div id="news-left-pane">
                        <div id="news-filters">
                            <select id="news-filter-company" class="controls-select" onchange="filterNews()" title="Filter news by company" style="min-width: 150px;">
                                <!-- Populated JS -->
                            </select>
                            
                            <select id="news-filter-source" class="controls-select" onchange="filterNews()" title="Filter news by source" style="min-width: 120px;">
                                <option value="all">Source (All)</option>
                            </select>

                            <div class="date-range-dropdown">
                                <button id="news-date-range-btn" class="controls-input" onclick="toggleDateRangeMenu()" title="Select a date range for news">Date Range (All) &#9662;</button>
                                <div id="news-date-range-content" class="date-range-content">
                                    <div class="date-option" onclick="selectNewsDateRange('all')">All Dates</div>
                                    <div class="date-option" onclick="selectNewsDateRange('7d')">Last 7 Days</div>
                                    <div class="date-option" onclick="selectNewsDateRange('30d')">Last 30 Days</div>
                                    <div class="date-option" onclick="toggleCustomDateRow()">Custom Range...</div>
                                    <div id="custom-date-row" class="custom-date-row">
                                        <input type="date" id="news-date-start" class="controls-input">
                                        <input type="date" id="news-date-end" class="controls-input">
                                        <button class="controls-input" onclick="applyCustomNewsDate()">Apply</button>
                                    </div>
                                </div>
                            </div>
                            
                            <input type="text" id="news-search" class="controls-input" placeholder="Search title..." style="flex:1;" oninput="filterNews()">
                            
                            <button class="controls-input" onclick="resetNewsFilters()" title="Reset filters">
                                <i class="material-icons">restart_alt</i>
                            </button>
                        </div>
                         
                         <div id="news-list" style="overflow-y:auto; flex:1;"></div>
                    </div>
                    <div id="news-resizer"></div>
                    <div id="news-right-pane">
                        <div style="text-align:center; color:#999; margin-top:50px;">Select a news item to read</div>
                    </div>
                </div>
            </div>

            <div id="mci-settings" class="tab-content">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <div>
                        <h3>Custom Index (MCI) Weights</h3>
                        <p style="color:var(--text-secondary); font-size:0.9rem;">Rows are Rebalance Dates. Columns are Tickers. Edit names in headers or weights in cells (%).</p>
                    </div>
                    <div style="display:flex; gap:10px;">
                         <button class="controls-input" onclick="addMciTicker()">+ Add Ticker Column</button>
                    </div>
                </div>
                
                <div class="mci-grid-wrapper">
                    <table class="mci-table" id="mci-weights-table">
                        <!-- Populated by JS -->
                    </table>
                </div>
                
                <button class="controls-input" style="margin-top:20px; background: var(--primary-color); color:white; border:none;" onclick="saveMciConfig()">
                    <i class="material-icons">save</i> Save & Recalculate MCI
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="columnModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeModal('columnModal')">&times;</span>
            <h2 class="modal-header" style="margin-bottom:15px;">Customize Columns</h2>
            <div id="column-list" class="column-list-container"></div>
            <button class="controls-input" onclick="applyColumnChanges()" style="width: 100%; justify-content: center; margin-top:15px;">Apply</button>
        </div>
    </div>
    
    <!-- Ticker Chart Modal -->
    <div id="tickerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('tickerModal')">&times;</span>
            <h2 id="modalTickerName"></h2>
            <div style="height: 400px; width: 100%;">
                <canvas id="individualTickerChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const TICKER_NAMES = {
            '2330.TW': 'TSMC', 'TSM': 'TSMC ADR', 'TSM.N': 'TSMC ADR',
            '.TWII': 'TWSE', '.SOX': 'SOX', '.SPX': 'S&P 500', '.MCI': 'MCI',
            'NVDA': 'Nvidia', 'NVDA.O': 'Nvidia', 
            'AAPL': 'Apple', 'AAPL.O': 'Apple', 
            'AVGO': 'Broadcom', 'AVGO.O': 'Broadcom',
            'QCOM': 'Qualcomm', 'QCOM.O': 'Qualcomm',
            'AMD': 'AMD', 'AMD.O': 'AMD',
            'ADI': 'Analog Devices', 'ADI.O': 'Analog Devices',
            '2454.TW': 'MediaTek',
            '6723.T': 'Renesas', 
            'INTC': 'Intel', 'INTC.O': 'Intel',
            '005930.KS': 'Samsung',
            '2303.TW': 'UMC', '0981.HK': 'SMIC-H', '688981.SS': 'SMIC-A', 'GFS': 'GlobalFoundries'
        };

        const TICKER_DOMAINS = {
            '2330.TW': 'tsmc.com', 'TSM': 'tsmc.com', 'TSM.N': 'tsmc.com',
            'NVDA': 'nvidia.com', 'NVDA.O': 'nvidia.com',
            'AAPL': 'apple.com', 'AAPL.O': 'apple.com',
            'AVGO': 'broadcom.com', 'AVGO.O': 'broadcom.com',
            'QCOM': 'qualcomm.com', 'QCOM.O': 'qualcomm.com',
            'AMD': 'amd.com', 'AMD.O': 'amd.com',
            'ADI': 'analog.com', 'ADI.O': 'analog.com',
            '2454.TW': 'mediatek.com',
            '6723.T': 'renesas.com', 
            'INTC': 'intel.com', 'INTC.O': 'intel.com',
            '005930.KS': 'samsung.com',
            '2303.TW': 'umc.com', '0981.HK': 'smics.com', '688981.SS': 'smics.com', 'GFS': 'gf.com',
            '.TWII': 'twse.com.tw', '.SOX': 'nasdaq.com', '.SPX': 'spglobal.com'
        };

        const TICKER_COLORS = {
            '2330.TW': '#8b0000', 'TSM': '#a52a2a', 'TSM.N': '#a52a2a', '.MCI': '#ff9900',
            '.TWII': '#000000', '.SOX': '#008080', '.SPX': '#555555',
            'NVDA': '#76b900', 'NVDA.O': '#76b900',
            'AAPL': '#A2AAAD', 'AAPL.O': '#A2AAAD',
            'AVGO': '#CC092F', 'AVGO.O': '#CC092F',
            'QCOM': '#3253DC', 'QCOM.O': '#3253DC',
            'AMD': '#ED1C24', 'AMD.O': '#ED1C24',
            'ADI': '#212529', 'ADI.O': '#212529',
            '2454.TW': '#3366CC', '6723.T': '#005CAB', 
            'INTC': '#0071C5', 'INTC.O': '#0071C5',
            '005930.KS': '#1428A0', '2303.TW': '#003366', '0981.HK': '#E31B23',
            '688981.SS': '#B22222', 'GFS': '#FF6A13'
        };

        let summaryTickersConfig = {
            'equity-index': ['.TWII', '.SOX', '.SPX', '.MCI'],
            'tw-stocks': ['2330.TW', 'TSM'], 
            'us-stocks': ['NVDA', 'AAPL', 'AVGO', 'QCOM', 'AMD', 'ADI', '2454.TW', '6723.T', 'INTC', '005930.KS', '2303.TW', '0981.HK', '688981.SS', 'GFS']
        };

        let mciMembers = ['NVDA', 'QCOM', 'AMD', 'AAPL', 'ADI', '2454.TW', 'AVGO', '6723.T'];
        let defaultWeights = { 'NVDA': 30, 'QCOM': 10, 'AMD': 15, 'AAPL': 15, 'ADI': 5, '2454.TW': 10, 'AVGO': 10, '6723.T': 5 };
        
        let mciWeightHistory = []; 

        let summaryColumnsState = [
            { id: 'Name', label: 'Name', visible: true },
            { id: 'Ticker', label: 'Ticker', visible: true },
            { id: 'Date', label: 'Date', visible: true },
            { id: 'Local Ccy', label: 'Ccy', visible: true },
            { id: 'Price', label: 'Price', visible: true },
            { id: '1-Day', label: '1-Day', visible: true },
            { id: '1-Week', label: '1-Week', visible: true },
            { id: '1-Month', label: '1-Month', visible: true },
            { id: '1-Year', label: '1-Year', visible: true },
            { id: 'YTD', label: 'YTD', visible: true },
            { id: 'Since', label: 'Since 2020', visible: false } 
        ];

        let allData = [];
        let dataByTicker = {}; 
        let allPerformanceData = new Map(); 
        let latestDataDate = null;
        let summaryReferenceDate = null;
        let activeCharts = {};
        let tickerMetadata = {};
        let newsSources = new Set();
        let loadedNewsTickers = new Set();
        let fullNewsList = []; 
        let newsSelectedRange = { start: null, end: null };
        
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initNewsResizer();
            loadAllDataFromGitHub();
            document.addEventListener('click', (e) => {
               if (!e.target.closest('.date-range-dropdown')) {
                   const menu = document.getElementById('news-date-range-content');
                   if(menu) menu.classList.remove('show');
               }
            });
        });

        async function fetchJsonWithRetry(url) {
            try {
                const res = await fetch(url);
                if (!res.ok) return null; 
                return await res.json();
            } catch (e) { return null; }
        }

        async function loadAllDataFromGitHub() {
            const urls = [
                'https://raw.githubusercontent.com/andychu221/yhfinance-fred-data/main/market_data/Equity_Index.json',
                'https://raw.githubusercontent.com/andychu221/yhfinance-fred-data/main/market_data/TW_Stocks.json',
                'https://raw.githubusercontent.com/andychu221/yhfinance-fred-data/main/market_data/US_Stocks.json'
            ];

            const loading = document.getElementById('loading-overlay');
            const status = document.getElementById('loading-text');

            try {
                status.innerText = "Fetching Market Data...";
                const results = await Promise.all(urls.map(u => fetchJsonWithRetry(u)));
                
                allData = [];
                dataByTicker = {};

                results.forEach((json, idx) => {
                    if (!json) return;
                    const market = idx === 0 ? 'Equity Index' : (idx === 1 ? 'TW Stocks' : 'US Stocks');
                    Object.entries(json).forEach(([rawTicker, data]) => {
                        let cleanTicker = rawTicker;
                        if (rawTicker.endsWith('.O') || rawTicker.endsWith('.N')) {
                            cleanTicker = rawTicker.split('.')[0];
                        }
                        if (cleanTicker === 'TSM.N') cleanTicker = 'TSM';

                        processTickerData(cleanTicker, data, market);
                    });
                });

                status.innerText = "Initializing MCI Weights...";
                initMciWeightHistory(); 
                renderMciTable();      

                status.innerText = "Calculating Custom Index (MCI)...";
                calculateMCI();

                let maxDate = 0;
                Object.keys(dataByTicker).forEach(t => {
                    dataByTicker[t].sort((a,b) => a.date - b.date);
                    if (dataByTicker[t].length) {
                        const d = dataByTicker[t][dataByTicker[t].length-1].date.getTime();
                        if (d > maxDate) maxDate = d;
                    }
                });
                latestDataDate = new Date(maxDate);
                summaryReferenceDate = latestDataDate;
                document.getElementById('summary-as-of-date').value = formatDateYYYYMMDD(latestDataDate);

                processPerformanceData();
                renderSummaryTab();
                renderChartTab();
                
                status.innerText = "Loading News...";
                await loadNews();

                loading.style.display = 'none';

            } catch (e) {
                status.innerText = "Error loading data: " + e.message;
                console.error(e);
            }
        }

        function processTickerData(ticker, raw, market) {
            if (!raw || !raw.date || !raw.close) return;
            tickerMetadata[ticker] = { float: parseMetric(raw.float) };
            const closes = raw.close;
            const dates = raw.date;
            const vols = raw.volume || [];
            const cleanData = [];
            dates.forEach((dStr, i) => {
                const price = closes[i];
                if (price == null) return;
                const date = new Date(dStr); 
                cleanData.push({ ticker, date, price, volume: vols[i] || 0, originalDateStr: dStr, market });
            });
            if (!dataByTicker[ticker]) dataByTicker[ticker] = [];
            dataByTicker[ticker] = dataByTicker[ticker].concat(cleanData);
            allData = allData.concat(cleanData);
        }

        function parseMetric(val) {
            if (!val) return null;
            if (typeof val === 'number') return val;
            let mult = 1;
            if (val.endsWith('B')) mult = 1e9;
            if (val.endsWith('M')) mult = 1e6;
            return parseFloat(val.replace(/[BM,]/g, '')) * mult;
        }

        function initMciWeightHistory() {
            mciWeightHistory = [];
            let curr = new Date('2020-01-01');
            const now = new Date();
            
            while (curr <= now) {
                const dStr = formatDateYYYYMMDD(curr);
                mciWeightHistory.push({
                    date: dStr,
                    weights: { ...defaultWeights } 
                });
                curr.setMonth(curr.getMonth() + 3);
            }
        }

        function renderMciTable() {
            const table = document.getElementById('mci-weights-table');
            let thead = '<thead><tr><th style="min-width:100px;">Date</th>';
            mciMembers.forEach((m, idx) => {
                thead += `<th style="min-width:80px;"><input class="mci-header-input" value="${m}" onchange="updateMciHeader(this, ${idx})"></th>`;
            });
            thead += '</tr></thead>';
            let tbody = '<tbody>';
            mciWeightHistory.forEach((row, rowIdx) => {
                tbody += `<tr><td>${row.date}</td>`;
                mciMembers.forEach(m => {
                    const val = row.weights[m] !== undefined ? row.weights[m] : 0;
                    tbody += `<td><input type="number" class="mci-input" value="${val}" data-row="${rowIdx}" data-ticker="${m}" onchange="updateMciWeight(this)"></td>`;
                });
                tbody += '</tr>';
            });
            tbody += '</tbody>';
            table.innerHTML = thead + tbody;
        }

        function updateMciHeader(input, colIdx) {
            const newTicker = input.value.trim();
            if(!newTicker) return;
            const oldTicker = mciMembers[colIdx];
            if (newTicker === oldTicker) return;
            mciMembers[colIdx] = newTicker;
            mciWeightHistory.forEach(row => {
                if (row.weights.hasOwnProperty(oldTicker)) {
                    row.weights[newTicker] = row.weights[oldTicker];
                    delete row.weights[oldTicker];
                } else {
                    row.weights[newTicker] = 0;
                }
            });
        }

        function updateMciWeight(input) {
            const rowIdx = parseInt(input.dataset.row);
            const ticker = input.dataset.ticker;
            const val = parseFloat(input.value) || 0;
            if(mciWeightHistory[rowIdx] && mciWeightHistory[rowIdx].weights) {
                mciWeightHistory[rowIdx].weights[ticker] = val;
            }
        }

        function addMciTicker() {
            const newTicker = "NEW";
            mciMembers.push(newTicker);
            mciWeightHistory.forEach(h => h.weights[newTicker] = 0);
            renderMciTable();
        }

        function saveMciConfig() {
            const loading = document.getElementById('loading-overlay');
            loading.style.display = 'flex';
            document.getElementById('loading-text').innerText = "Recalculating MCI...";
            setTimeout(() => {
                dataByTicker['.MCI'] = [];
                allData = allData.filter(d => d.ticker !== '.MCI');
                calculateMCI();
                if (dataByTicker['.MCI']) {
                    dataByTicker['.MCI'].sort((a,b) => a.date - b.date);
                    allData = allData.concat(dataByTicker['.MCI']);
                }
                processPerformanceData();
                renderSummaryTab();
                renderChartTab();
                loading.style.display = 'none';
                alert('MCI updated successfully.');
            }, 100);
        }

        function calculateMCI() {
            const historyMap = {}; 
            mciWeightHistory.forEach(h => { historyMap[h.date] = h.weights; });

            const validMembers = mciMembers.filter(m => dataByTicker[m] && dataByTicker[m].length > 0);
            if (validMembers.length === 0) return;

            const priceMap = {}; 
            validMembers.forEach(t => {
                dataByTicker[t].forEach(pt => {
                    const dStr = formatDateYYYYMMDD(pt.date);
                    if (!priceMap[dStr]) priceMap[dStr] = {};
                    priceMap[dStr][t] = pt.price;
                });
            });

            const allDates = Object.keys(priceMap).sort();
            const startIndex = allDates.findIndex(d => d >= '2020-01-01');
            if (startIndex === -1) return;

            const mciData = [];
            let currentValue = 100;
            let prevPrices = {};
            const startDStr = allDates[startIndex];
            validMembers.forEach(t => { if (priceMap[startDStr][t]) prevPrices[t] = priceMap[startDStr][t]; });
            
            const startDate = new Date(startDStr);
            mciData.push({ ticker: '.MCI', date: startDate, price: 100, volume: 0, originalDateStr: startDStr, market: 'Equity Index' });

            for (let i = startIndex + 1; i < allDates.length; i++) {
                const dStr = allDates[i];
                const date = new Date(dStr);
                const currentPrices = priceMap[dStr];
                
                let applicableWeights = defaultWeights;
                for (let k = mciWeightHistory.length - 1; k >= 0; k--) {
                    if (mciWeightHistory[k].date <= dStr) {
                        applicableWeights = mciWeightHistory[k].weights;
                        break;
                    }
                }

                let totalW = 0;
                validMembers.forEach(t => totalW += (applicableWeights[t] || 0));
                if (totalW === 0) totalW = 1;

                let compositeReturn = 0;
                validMembers.forEach(t => {
                    const w = (applicableWeights[t] || 0) / totalW;
                    const currP = currentPrices[t];
                    const prevP = prevPrices[t];
                    let dailyRet = 0;
                    if (currP && prevP) dailyRet = (currP / prevP) - 1;
                    compositeReturn += w * dailyRet;
                    if (currP) prevPrices[t] = currP;
                });

                currentValue = currentValue * (1 + compositeReturn);
                mciData.push({ ticker: '.MCI', date: date, price: currentValue, volume: 0, originalDateStr: dStr, market: 'Equity Index' });
            }
            dataByTicker['.MCI'] = mciData;
        }

        function processPerformanceData() {
            allPerformanceData.clear();
            Object.keys(dataByTicker).forEach(ticker => {
                const data = dataByTicker[ticker];
                if (!data || data.length === 0) return;
                const market = data[0].market;
                allPerformanceData.set(ticker, calculatePerformanceForTicker(ticker, data, market));
            });
        }

        function calculatePerformanceForTicker(ticker, tickerData, market) {
            let currency = '';
            if (ticker.endsWith('.TW') || ticker === '.TWII') currency = 'TWD';
            else if (ticker.endsWith('.HK')) currency = 'HKD';
            else if (ticker.endsWith('.SS')) currency = 'CNY';
            else if (ticker.endsWith('.T')) currency = 'JPY';
            else if (ticker.endsWith('.KS')) currency = 'KRW';
            else currency = 'USD';

            const findPriceOnOrBefore = (date) => {
                if (!date) return null;
                const target = date.getTime();
                for (let i = tickerData.length - 1; i >= 0; i--) {
                    if (tickerData[i].date.getTime() <= target) return tickerData[i].price;
                }
                return null;
            };
            const findActualDataPoint = (date) => {
                 if (!date) return null;
                 const target = date.getTime();
                 for (let i = tickerData.length - 1; i >= 0; i--) {
                    if (tickerData[i].date.getTime() <= target) return tickerData[i];
                 }
                 return null;
            };
            const calcPerf = (startPrice, endPrice) => {
                if (!startPrice || !endPrice) return null;
                return ((endPrice / startPrice) - 1) * 100;
            };
            return { ticker, name: TICKER_NAMES[ticker] || ticker, currency, findPriceOnOrBefore, findActualDataPoint, calcPerf };
        }

        async function loadNews() {
            const newsTickers = ['2330.TW', 'TSM', 'NVDA', 'AAPL', 'AVGO', 'QCOM', 'AMD', 'ADI', '2454.TW', '6723.T', 'INTC', '005930.KS', '2303.TW', '0981.HK', '688981.SS', 'GFS'];
            const listEl = document.getElementById('news-list'); 
            listEl.innerHTML = '<p style="padding:10px;">Loading news...</p>';
            let allNews = [];
            newsSources = new Set();
            loadedNewsTickers = new Set();
            
            const fetches = newsTickers.map(t => {
                let filename = t; 
                return fetchJsonWithRetry(`https://raw.githubusercontent.com/andychu221/reuters-news-archive/main/taiwan-stock-news/${filename}.json`)
                    .then(json => {
                        let list = [];
                        if (json) {
                            if (Array.isArray(json)) list = json;
                            else if (json.news) list = json.news;
                            
                            if (list.length > 0) loadedNewsTickers.add(t);

                            list.forEach(n => {
                                n.ticker = t;
                                n.jsDate = new Date(n.Date + ' ' + (n.Time || ''));
                                if(n.Source) newsSources.add(n.Source);
                            });
                            allNews = allNews.concat(list);
                        }
                    });
            });
            await Promise.all(fetches); 
            allNews.sort((a,b) => b.jsDate - a.jsDate); 
            fullNewsList = allNews; 
            
            populateNewsFilters();
            filterNews();
        }

        function populateNewsFilters() {
            const tkSelect = document.getElementById('news-filter-company');
            tkSelect.innerHTML = '<option value="all">Company (All)</option>';
            Array.from(loadedNewsTickers).sort().forEach(t => {
                tkSelect.innerHTML += `<option value="${t}">${TICKER_NAMES[t] || t}</option>`;
            });

            const srcSelect = document.getElementById('news-filter-source');
            srcSelect.innerHTML = '<option value="all">Source (All)</option>';
            Array.from(newsSources).sort().forEach(s => {
                srcSelect.innerHTML += `<option value="${s}">${s}</option>`;
            });
        }
        
        function toggleDateRangeMenu() { document.getElementById('news-date-range-content').classList.toggle('show'); }
        function toggleCustomDateRow() { document.getElementById('custom-date-row').classList.toggle('active'); }

        function selectNewsDateRange(range) {
            const now = new Date();
            if (range === 'all') {
                newsSelectedRange = { start: null, end: null };
            } else if (range === '7d') {
                const past = new Date(); past.setDate(now.getDate() - 7);
                newsSelectedRange = { start: now, end: past };
            } else if (range === '30d') {
                const past = new Date(); past.setDate(now.getDate() - 30);
                newsSelectedRange = { start: now, end: past };
            }
            updateDateRangeButtonLabel();
            document.getElementById('news-date-range-content').classList.remove('show');
            filterNews();
        }

        function applyCustomNewsDate() {
            const startVal = document.getElementById('news-date-start').value;
            const endVal = document.getElementById('news-date-end').value;
            if (startVal && endVal) {
                newsSelectedRange = { start: new Date(endVal), end: new Date(startVal) }; 
                updateDateRangeButtonLabel();
                document.getElementById('news-date-range-content').classList.remove('show');
                filterNews();
            }
        }

        function updateDateRangeButtonLabel() {
            const btn = document.getElementById('news-date-range-btn');
            if (!newsSelectedRange.start) {
                btn.textContent = 'Date Range (All) \u25BE';
            } else {
                btn.textContent = `${formatDateYYYYMMDD(newsSelectedRange.end)} - ${formatDateYYYYMMDD(newsSelectedRange.start)} \u25BE`;
            }
        }
        
        function resetNewsFilters() {
            document.getElementById('news-filter-company').value = 'all';
            document.getElementById('news-filter-source').value = 'all';
            newsSelectedRange = { start: null, end: null };
            updateDateRangeButtonLabel();
            document.getElementById('news-search').value = '';
            filterNews();
        }

        function filterNews() {
            if (!fullNewsList) return;
            const text = document.getElementById('news-search').value.toLowerCase();
            const tickerFilter = document.getElementById('news-filter-company').value;
            const sourceFilter = document.getElementById('news-filter-source').value;

            const listEl = document.getElementById('news-list');
            listEl.innerHTML = '';

            const filtered = fullNewsList.filter(n => {
                const matchesText = n.Title.toLowerCase().includes(text) || (TICKER_NAMES[n.ticker] || '').toLowerCase().includes(text);
                const matchesTicker = tickerFilter === 'all' || n.ticker === tickerFilter;
                const matchesSource = sourceFilter === 'all' || n.Source === sourceFilter;
                
                let matchesDate = true;
                if (newsSelectedRange.start && newsSelectedRange.end) {
                    const itemDate = new Date(n.Date);
                    matchesDate = itemDate <= newsSelectedRange.start && itemDate >= newsSelectedRange.end;
                }

                return matchesText && matchesTicker && matchesSource && matchesDate;
            });

            if (filtered.length === 0) {
                listEl.innerHTML = '<p style="padding:10px; color:#666;">No news found matching filters.</p>';
            } else {
                renderNewsList(filtered);
            }
        }

        function renderNewsList(items) {
            const listEl = document.getElementById('news-list'); 
            items.slice(0, 100).forEach(n => {
                const div = document.createElement('div'); div.className = 'news-item';
                const lang = (n.Title.match(/[\u4e00-\u9fa5]/)) ? 'CH' : 'EN';
                div.innerHTML = `
                    <div class="news-meta">
                        <span class="news-tag" style="background:${TICKER_COLORS[n.ticker]||'#ccc'}; color:white;">${TICKER_NAMES[n.ticker] || n.ticker}</span>
                        <span class="news-tag">${lang}</span>
                        <span>${n.Date}</span>
                        <span style="margin-left:auto;">${n.Source || 'Source'}</span>
                    </div>
                    <div class="news-title">${n.Title}</div>
                `;
                div.onclick = () => {
                    document.querySelectorAll('.news-item').forEach(el=>el.classList.remove('active'));
                    div.classList.add('active');
                    showNewsContent(n);
                };
                listEl.appendChild(div);
            });
        }

        function showNewsContent(item) {
            const pane = document.getElementById('news-right-pane');
            pane.scrollTop = 0;
            pane.innerHTML = `
                <h2 style="margin-bottom:10px;">${item.Title}</h2>
                <div style="color:#666; margin-bottom:20px; font-size:0.9rem; border-bottom:1px solid #eee; padding-bottom:10px;">
                    ${TICKER_NAMES[item.ticker] || item.ticker} | ${item.Source || 'Unknown Source'} | ${item.Date} ${item.Time || ''}
                </div>
                <div style="white-space: pre-wrap; line-height:1.8; font-size:1rem; color:#333;">${item.Content || 'No content available.'}</div>
                <br>
                <a href="${item.URL}" target="_blank" style="color:var(--primary-color); font-weight:bold;">Read Original Article <i class="material-icons" style="font-size:12px;">open_in_new</i></a>
            `;
        }

        function renderChartTab() {
            if (document.getElementById('chart-grid').classList.contains('active')) renderPerformanceGrid();
            else renderMciComparison();
        }
        
        function renderPerformanceGrid() {
            const tickers = ['2330.TW', 'TSM', 'INTC', '005930.KS', '2303.TW', '0981.HK', '688981.SS', 'GFS', '.TWII', '.SOX'];
            const validTickers = tickers.filter(t => dataByTicker[t]);
            const periods = ['1-Year', 'YTD', '1-Month', '1-Week'];
            const canvasIds = ['canvas-1y', 'canvas-ytd', 'canvas-1m', 'canvas-1w'];
            
            periods.forEach((p, idx) => renderLineChartWithCustomTicks(canvasIds[idx], validTickers, p));
            renderStatsTable(validTickers, periods);
        }

        function getLogoHtml(ticker) {
            const domain = TICKER_DOMAINS[ticker];
            if (!domain) return '';
            return `<img src="https://getlogo.dev/logos/${domain}?token=pub_97e0e4df192f20dd2626307d2148f88d" style="width:20px; height:20px; vertical-align:middle; margin-right:8px; border-radius:50%; object-fit:contain; background:white;" onerror="this.style.display='none'">`;
        }

        function renderLineChartWithCustomTicks(canvasId, tickers, periodName) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (activeCharts[canvasId]) {
                 activeCharts[canvasId].destroy();
                 activeCharts[canvasId] = null;
            }

            const endDate = summaryReferenceDate;
            let startDate;
            if (periodName === '1-Year') startDate = new Date(new Date(endDate).setFullYear(endDate.getFullYear() - 1));
            else if (periodName === 'YTD') startDate = new Date(endDate.getFullYear(), 0, 1);
            else if (periodName === '1-Month') startDate = new Date(new Date(endDate).setMonth(endDate.getMonth() - 1));
            else if (periodName === '1-Week') startDate = new Date(new Date(endDate).setDate(endDate.getDate() - 7));

            const rangeData = allData.filter(d => d.date >= startDate && d.date <= endDate);
            const uniqueDates = [...new Set(rangeData.map(d => d.date.getTime()))].sort((a,b)=>a-b);
            const labels = uniqueDates.map(t => new Date(t));
            const dateMap = new Map(); labels.forEach((d, i) => dateMap.set(d.getTime(), i));

            const datasets = tickers.map(t => {
                const tData = dataByTicker[t].filter(pt => pt.date >= startDate && pt.date <= endDate);
                if (tData.length === 0) return null;
                const basePrice = tData[0].price;
                const dataArr = new Array(labels.length).fill(null);
                tData.forEach(pt => {
                    const idx = dateMap.get(pt.date.getTime());
                    if (idx !== undefined) dataArr[idx] = ((pt.price/basePrice)-1)*100;
                });
                return { label: TICKER_NAMES[t] || t, data: dataArr, borderColor: TICKER_COLORS[t] || '#999', borderWidth: 2, pointRadius: 0, tension: 0.1, spanGaps: true };
            }).filter(Boolean);

            const isDarkMode = document.body.classList.contains('dark-mode');
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDarkMode ? '#a0a0a0' : '#555';

            const shouldShowTick = (index) => {
                if (index === 0) return true;
                const date = labels[index];
                const prevDate = labels[index - 1];
                if (!date || !prevDate) return false;
                if (periodName === '1-Week') return true;
                if (periodName === '1-Month') {
                    if (date.getDay() < prevDate.getDay() || (date - prevDate > 6 * 86400000)) return true;
                    return false;
                }
                if (periodName === 'YTD' || periodName === '1-Year') return date.getMonth() !== prevDate.getMonth();
                return false;
            };

            activeCharts[canvasId] = new Chart(ctx, {
                type: 'line', data: { labels, datasets },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    layout: { padding: { top: 10 } },
                    scales: { 
                        x: {
                            type: 'category', 
                            offset: false,
                            ticks: { 
                                color: textColor, maxRotation: 0, autoSkip: false,
                                callback: function(val, index) {
                                     if (!shouldShowTick(index)) return null;
                                     if (periodName === '1-Week') return formatDateDDMMM(labels[index]);
                                     if (periodName === '1-Month') return formatDateDDMMM(labels[index]);
                                     if (periodName === 'YTD' || periodName === '1-Year') return formatDateDDMMM(labels[index]).split('/')[1];
                                     return null;
                                }
                            },
                            grid: { 
                                color: (ctx) => shouldShowTick(ctx.index) ? gridColor : 'transparent',
                                drawTicks: true,
                                offset: false
                            }
                        },
                        y: { title: { display: true, text: '%' }, ticks: { color: textColor }, grid: { color: gridColor } } 
                    }, 
                    plugins: { 
                        title: { display: true, text: `${periodName} Trend`, color: textColor, font: { size: 14, weight: 'bold' }, align: 'start' },
                        legend: { 
                            display: true, 
                            position: 'top', 
                            align: 'end',
                            labels: { 
                                color: textColor, boxWidth: 10, font: { size: 10 }, 
                                usePointStyle: true, pointStyle: 'rect', padding: 10 
                            }
                        }, 
                        tooltip: { mode: 'index', intersect: false }
                    } 
                }
            });
        }

        function renderStatsTable(tickers, periods) {
            const table = document.getElementById('stats-table-grid');
            let html = '<thead><tr><th>Period</th>';
            tickers.forEach(t => html += `<th>${TICKER_NAMES[t] || t}</th>`);
            html += '</tr></thead><tbody>';

            const allPeriods = [...periods, 'Turnover'];
            allPeriods.forEach(p => {
                html += `<tr><td>${p}</td>`;
                tickers.forEach(t => {
                    const perfData = allPerformanceData.get(t);
                    if (!perfData) { html += '<td>-</td>'; return; }
                    const currPoint = perfData.findActualDataPoint(summaryReferenceDate);
                    
                    if (p === 'Turnover') {
                        let turnover = '-';
                        const float = tickerMetadata[t]?.float;
                        if (currPoint && float) {
                             const tVal = (currPoint.volume / float) * 100;
                             turnover = tVal.toFixed(2) + '%';
                        }
                        html += `<td>${turnover}</td>`;
                    } else {
                        let d = new Date(summaryReferenceDate);
                        if (p === '1-Day') d.setDate(d.getDate() - 1);
                        else if (p === '1-Week') d.setDate(d.getDate() - 7);
                        else if (p === '1-Month') d.setMonth(d.getMonth() - 1);
                        else if (p === '1-Year') d.setFullYear(d.getFullYear() - 1);
                        else if (p === 'YTD') d = new Date(d.getFullYear(), 0, 1);
                        const startPrice = perfData.findPriceOnOrBefore(d);
                        if (currPoint && startPrice) {
                            const ret = perfData.calcPerf(startPrice, currPoint.price);
                            const css = ret >= 0 ? 'text-positive' : 'text-negative';
                            html += `<td class="${css}">${ret.toFixed(2)}%</td>`;
                        } else { html += '<td>-</td>'; }
                    }
                });
                html += '</tr>';
            });
            html += '</tbody>';
            table.innerHTML = html;
        }

        function renderMciComparison() {
            const canvasId = 'canvas-mci-comp';
            if (activeCharts[canvasId]) {
                activeCharts[canvasId].destroy();
                activeCharts[canvasId] = null;
            }
            const ctx = document.getElementById(canvasId).getContext('2d');
            const tsmc = dataByTicker['2330.TW']; const mci = dataByTicker['.MCI'];
            if (!tsmc || !mci) return;
            const startDate = new Date('2020-01-01');
            const filter = (arr) => arr.filter(pt => pt.date >= startDate && pt.date <= summaryReferenceDate);
            const tData = filter(tsmc); const mData = filter(mci);
            
            const rangeData = tData; 
            const uniqueDates = [...new Set(rangeData.map(d => d.date.getTime()))].sort((a,b)=>a-b);
            const labels = uniqueDates.map(t => new Date(t));
            const dateMap = new Map(); labels.forEach((d, i) => dateMap.set(d.getTime(), i));

            const normalize = (arr) => {
                if(arr.length===0) return [];
                const base = arr[0].price;
                const dataArr = new Array(labels.length).fill(null);
                arr.forEach(pt => { const idx = dateMap.get(pt.date.getTime()); if (idx !== undefined) dataArr[idx] = ((pt.price/base) * 100); });
                return dataArr;
            };

            const datasets = [
                { label: 'TSMC (2330.TW)', data: normalize(tData), borderColor: TICKER_COLORS['2330.TW'], borderWidth: 2, pointRadius: 0, tension: 0.1 },
                { label: 'MCI', data: normalize(mData), borderColor: TICKER_COLORS['.MCI'], borderWidth: 2, pointRadius: 0, tension: 0.1 }
            ];

            const isDarkMode = document.body.classList.contains('dark-mode');
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDarkMode ? '#a0a0a0' : '#555';
            
            const shouldShowTick = (index) => {
                if (index === 0) return true;
                const date = labels[index];
                const prevDate = labels[index-1];
                if (!date || !prevDate) return false;
                return date.getFullYear() !== prevDate.getFullYear();
            };

            activeCharts[canvasId] = new Chart(ctx, {
                type: 'line', data: { labels, datasets },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { 
                        x: {
                            type: 'category', 
                            offset: false,
                            ticks: { 
                                color: textColor, maxRotation: 0, autoSkip: false,
                                callback: (val, index) => shouldShowTick(index) ? labels[index].getFullYear() : null
                            },
                            grid: { 
                                color: (ctx) => shouldShowTick(ctx.index) ? gridColor : 'transparent',
                                drawTicks: true,
                                offset: false
                            }
                        },
                        y: { title: { display: true, text: 'Base 100' }, ticks: { color: textColor }, grid: { color: gridColor } } 
                    },
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'top', 
                            labels: { 
                                color: textColor, boxWidth: 12, padding: 15, font: { size: 12 },
                                usePointStyle: true, pointStyle: 'rect'
                            } 
                        },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }

        function renderSummaryTab() {
            const refDate = summaryReferenceDate;
            const containers = {'equity-index': 'summary-equity-index', 'tw-stocks': 'summary-tw-stocks', 'us-stocks': 'summary-us-stocks'};
            Object.entries(containers).forEach(([group, id]) => {
                const tickers = summaryTickersConfig[group];
                const table = document.getElementById(id).querySelector('table');
                let html = '<thead><tr>';
                summaryColumnsState.forEach(col => { if(col.visible) html += `<th>${col.label}</th>`; });
                html += '</tr></thead><tbody>';

                tickers.forEach(t => {
                    const perfData = allPerformanceData.get(t);
                    if (!perfData) return;
                    const currPoint = perfData.findActualDataPoint(refDate);
                    if (!currPoint) return;

                    html += `<tr class="clickable-row" onclick="openTickerModal('${t}')">`;
                    summaryColumnsState.forEach(col => {
                        if (!col.visible) return;
                        let val = '-'; let css = '';
                        const price = currPoint.price;
                        const getP = (pd) => {
                            let d = new Date(refDate);
                            if (pd === '1-Day') d.setDate(d.getDate() - 1);
                            else if (pd === '1-Week') d.setDate(d.getDate() - 7);
                            else if (pd === '1-Month') d.setMonth(d.getMonth() - 1);
                            else if (pd === '1-Year') d.setFullYear(d.getFullYear() - 1);
                            else if (pd === 'YTD') d = new Date(d.getFullYear(), 0, 1);
                            else if (pd === 'Since') d = new Date('2020-01-01');
                            return perfData.findPriceOnOrBefore(d);
                        }
                        switch(col.id) {
                            case 'Name': 
                                val = `<div style="display:flex; align-items:center;">${getLogoHtml(t)}${perfData.name}</div>`; 
                                break;
                            case 'Ticker': val = t; break;
                            case 'Date': val = formatDateDDMMM(currPoint.date); break; 
                            case 'Local Ccy': val = perfData.currency; break;
                            case 'Price': val = formatNumberWithCommas(price, 2); break;
                            default: 
                                const startPrice = getP(col.id);
                                if (startPrice) {
                                    const ret = perfData.calcPerf(startPrice, price);
                                    val = ret.toFixed(2) + '%';
                                    css = ret >= 0 ? 'text-positive' : 'text-negative';
                                }
                                break;
                        }
                        html += `<td class="${css}">${val}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody>';
                table.innerHTML = html;
            });
        }

        function openChartSubTab(e, id) {
            document.querySelectorAll('.chart-sub-tab-link').forEach(el => el.classList.remove('active')); e.target.classList.add('active');
            document.querySelectorAll('.view-content').forEach(el => el.classList.remove('active')); document.getElementById(id).classList.add('active');
            renderChartTab();
        }
        function openTab(evt, tabName) { document.querySelectorAll(".tab-content, .tab-link").forEach(el => el.classList.remove("active")); document.getElementById(tabName).classList.add("active"); if (evt) evt.currentTarget.classList.add("active"); }
        function initTheme() {
            if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); document.getElementById('theme-icon-sun').style.display = 'none'; document.getElementById('theme-icon-moon').style.display = 'block'; }
            document.getElementById('theme-toggle').onclick = () => { document.body.classList.toggle('dark-mode'); const isDark = document.body.classList.contains('dark-mode'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); document.getElementById('theme-icon-sun').style.display = isDark ? 'none' : 'block'; document.getElementById('theme-icon-moon').style.display = isDark ? 'block' : 'none'; Object.values(activeCharts).forEach(c => { if(c) c.update() }); };
        }
        function initNewsResizer() {
            const resizer = document.getElementById('news-resizer'); const leftPane = document.getElementById('news-left-pane'); let isResizing = false;
            resizer.addEventListener('mousedown', (e) => { isResizing = true; document.body.style.cursor = 'col-resize'; document.body.style.userSelect = 'none'; });
            document.addEventListener('mousemove', (e) => { if (!isResizing) return; const containerOffset = document.getElementById('news-container').getBoundingClientRect().left; const newWidth = e.clientX - containerOffset; if (newWidth > 200 && newWidth < document.body.clientWidth - 200) { leftPane.style.flex = `0 0 ${newWidth}px`; } });
            document.addEventListener('mouseup', () => { isResizing = false; document.body.style.cursor = 'default'; document.body.style.userSelect = ''; });
        }
        function updateSummaryReferenceDate(val) { summaryReferenceDate = new Date(val); processPerformanceData(); renderSummaryTab(); renderChartTab(); }
        function openColumnModal() { const list = document.getElementById('column-list'); list.innerHTML = ''; summaryColumnsState.forEach((col, idx) => { list.innerHTML += `<div style="padding:5px; border-bottom:1px solid #eee;"><input type="checkbox" ${col.visible?'checked':''} id="col-chk-${idx}"><label for="col-chk-${idx}">${col.label}</label></div>`; }); document.getElementById('columnModal').style.display='block'; setTimeout(() => document.getElementById('columnModal').classList.add('show'),10); }
        function applyColumnChanges() { summaryColumnsState.forEach((col, idx) => { col.visible = document.getElementById(`col-chk-${idx}`).checked; }); closeModal('columnModal'); renderSummaryTab(); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); setTimeout(() => document.getElementById(id).style.display='none', 300); }
        function formatNumberWithCommas(x, decimals) { if (x == null) return '-'; return x.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }); }
        function formatDateYYYYMMDD(date) { return date.toISOString().split('T')[0]; }
        function formatDateDDMMM(date) { const month = date.toLocaleString('en-US', { month: 'short' }); const day = String(date.getDate()).padStart(2, '0'); return `${day}/${month}`; }
        function openTickerModal(ticker) {
            const modal = document.getElementById('tickerModal'); document.getElementById('modalTickerName').innerText = TICKER_NAMES[ticker] || ticker;
            modal.style.display = 'block'; setTimeout(() => modal.classList.add('show'), 10);
            const ctx = document.getElementById('individualTickerChart').getContext('2d');
            if (activeCharts['modal']) activeCharts['modal'].destroy();
            const data = dataByTicker[ticker];
            const recentData = data.filter(pt => pt.date > new Date(new Date(summaryReferenceDate).setFullYear(summaryReferenceDate.getFullYear()-1)));
            const labels = recentData.map(pt => pt.date);
            activeCharts['modal'] = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Price', data: recentData.map(pt => ({x: pt.date, y: pt.price})), borderColor: '#4a90e2', borderWidth: 2, fill: true, backgroundColor: '#4a90e233', pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'month' } } } } });
        }
    </script>
</body>
</html>
